<html>
	<head>
    	<script type='application/javascript' src='../js/jquery-1.6.2.min.js'></script>
      	<script type='application/javascript' src='https://raw.github.com/placemarker/jQuery-MD5/master/jquery.md5.js'></script>
      	
      	<script type='application/javascript'>
      		deviceId = "111111";
      		
      		function clean_msg(msg){
			    jsonMsg = {};
			    try{
			        jsonMsg = JSON.parse(msg);
			    }catch(err){}
			    
			    return jsonMsg
			}   
      		
      		function FlowMsg(msg) {
			    this.msg;

				if (msg == undefined){
            		this.msg = {"to": "", "from": "", "action": "", "hash": "", "body": "", "status": "", "timestamp": ""};
				}else{
					this.msg = clean_msg(msg);
				}
            
            	this.validate_hash = function(){
            		tmp = jQuery.extend(true, {}, this.msg);
					delete tmp["hash"]
					hashOut = $.md5(JSON.stringify(tmp));
					if (this.get_hash() == hashOut){
						return true;
					}else{
						return false;
					}
            	};
				
				this.get_value = function(key){
			        if (key in this.msg){
			            return this.msg[key];
			        }else{
			            return undefined;
			        }
			    };
			    
				this.set_value = function(key, value){
					this.msg[key] = value;
					if (key != "hash"){
						this.set_hash();
					}
			    };	
			    
			    this.get_to = function(){
			    	return this.get_value("to")
			    };
			    
			    this.get_from = function(){
			    	return this.get_value("from")
			    };
			    
			    this.get_action = function(){
			    	return this.get_value("action")
			    };
			    
			    this.get_body = function(){
			    	return this.get_value("body")
			    };		
			    
			    this.get_status = function(){
			    	return this.get_value("status")
			    };
			    
			    this.get_hash = function(){
			    	return this.get_value("hash")
			    };	    
			    
			    this.get_timestamp = function(){
			    	return this.get_value("timestamp")
			    };	

				this.set_to = function(val){
					this.set_value("to", val);
				};

				this.set_from = function(val){
					this.set_value("from", val);
				};

				this.set_action = function(val){
					this.set_value("action", val);
				};
				
				this.set_body = function(val){
					this.set_value("body", val);
				};			
				
				this.set_status = function(val){
					this.set_value("status", val);
				};
				
				this.set_timestamp = function(val){
					this.set_value("timestamp", val);
				};

				this.set_hash = function(){
					tmp = jQuery.extend(true, {}, this.msg);
					delete tmp["hash"]
					hashOut = $.md5(JSON.stringify(tmp));
					this.set_value("hash", hashOut);
				};

			    this.verify = function () {
			        return this.foo === this.bar;
			    };
			    
			    this.to_string = function () {
			    	this.set_timestamp(Math.round(new Date().getTime()/1000.0))
			        return JSON.stringify(this.msg)
			    };
			}
      	
      	
      		function wsAuthenticate(){
      			test = new FlowMsg();
      			test.set_to("000000");
      			test.set_from(deviceId);
      			test.set_action("AUTH_REQUEST");
      			test.set_status("200");
      			
      			console.log(test.to_string());
      			ws.send(test.to_string());
      		}
      	
      	
	        $(document).ready(function() {				
	          websocket = 'ws://localhost:9000/ws';
	          
	          if (window.WebSocket) {
	         	ws = new WebSocket(websocket);
	          }else if (window.MozWebSocket) {
	            ws = MozWebSocket(websocket);
	          }else {
	            alert('WebSocket Not Supported');
	          }
	
	
	
	
	          window.onbeforeunload = function(e) {
	            $('#chat').val($('#chat').val() + 'Bye bye...\\n');
	            ws.close(1000, 'hg left the room');
	                 
	            if(!e) e = window.event;
	            e.stopPropagation();
	            e.preventDefault();
	          };
	          
	          ws.onmessage = function (evt) {
	          	test = new FlowMsg(evt.data);
	          	console.log(test);
	          	
	          	if (test.get_action() == "AUTH_RESPONSE"){
	          		if(test.get_status() == 200){
	          			alert("cats");
	          		}
	          	}else if(test.get_action() == "AUTH_REQUEST"){
	          		wsAuthenticate();
	          	}else if(test.get_action() == "OPEN"){
	          		alert("OPEN"+test.get_body());
	          		window.open(test.get_body(),'_newtab');
	          	
	          	}
	          	
	          	
	          	$('#chat').val($('#chat').val() + evt.data + '\\n');
	          };
	          ws.onopen = function() {
	          	wsAuthenticate();
	          };
	          
	          ws.onclose = function(evt) {
	             $('#chat').val($('#chat').val() + 'Connection closed by server: ' + evt.code + ' \"' + evt.reason + '\"\\n');  
	          };
	
	          $('#send').click(function() {
	             console.log($('#message').val());
	             ws.send($('#message').val());
	             $('#message').val("");
	             return false;
	          });
	        });
    	</script>
    </head>
	<body>
    	<form action='#' id='chatform' method='get'>
	      	<textarea id='chat' cols='35' rows='10'></textarea>
	     	<br />
	      	<label for='message'>: </label><input type='text' id='message' />
	      	<input id='send' type='submit' value='Send' />
    	</form>
	</body>
</html>